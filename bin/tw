#!/usr/bin/env ruby
require File.expand_path '../lib/tw', File.dirname(__FILE__)

Tw::Opts.parse ARGV
if Tw::Opts.params['help']
  puts Tw.help
  exit
elsif Tw::Opts.params['user:list']
  Tw::Conf['users'].keys.each do |name|
    puts name == Tw::Conf['default_user'] ? "* #{name}" : "  #{name}"
  end
  puts "(#{Tw::Conf['users'].size} users)"
  exit
elsif Tw::Opts.params['user:default']
  Tw::Conf['default_user'] = Tw::Opts.params['user:default']
  Tw::Conf.save
  puts "set default user \"@#{Tw::Opts.params['user:default']}\""
  exit
end

c = Tw::Client.new

if Tw::Opts.params['pipe']
  STDIN.read.split(/[\r\n]+/).each do |line|
    line.split(/(.{140})/u).select{|m|m.size>0}.each do |message|
      c.tweet message
    end
    sleep 1
  end
  exit
end
if Tw::Opts.argv.size < 1
  Tw::Render.display c.mentions
elsif Tw::Opts.all_requests?
  Tw::Render.display Tw::Opts.argv.map{|arg|
    if word = Tw::Opts.search_word?(arg)
      res = c.search word
    elsif user = Tw::Opts.username?(arg)
      res = c.user_timeline user
    elsif (user, list = Tw::Opts.listname?(arg)) != false
      res = c.list_timeline(user, list)
    end
    res
  }
else
  message = Tw::Opts.argv.join(' ')
  if (len = message.split(//u).size) > 140
    puts "tweet too long (#{len} chars)"
    exit 1
  else
    puts "tweet \"#{message}\"?  (#{len} chars)"
    puts '[Y/n]'
    exit if STDIN.gets.strip =~ /^n/i
  end
  c.tweet message
end
